var CropTool=Class.extend(function(){function t(){this.handleCrop=o.bind(this),this.handleScaleDown=s.bind(this),this.handleScaleFull=l.bind(this),this.handleScaleReset=a.bind(this),this.handleScaleUp=c.bind(this),this.handleImageMouseDown=i.bind(this),this.handleMouseMove=n.bind(this),this.handleMouseUp=h.bind(this),w.find(".btn-crop").on("click",this.handleCrop),w.find(".btn-scale-down").on("click",this.handleScaleDown),w.find(".btn-scale-full").on("click",this.handleScaleFull),w.find(".btn-scale-reset").on("click",this.handleScaleReset),w.find(".btn-scale-up").on("click",this.handleScaleUp),p.on("mousedown touchstart",this.handleImageMouseDown)}function e(){d=w.find(".crop-mask"),p=d.find(".crop-image"),d.length||console.error('CropTool.initializeImage() => no mask found. Make sure you have an element with class of "crop-mask" within the scope you passed in to the constructor.'),p.length||console.error('CropTool.initializeImage() => no image found. Make sure you have an element with class of "crop-image" within the "crop-mask" element.');var t=p.get(0);m={height:Math.max(p.height(),t.height,t.clientHeight,t.naturalHeight),width:Math.max(p.width(),t.width,t.clientWidth,t.naturalWidth)};var e=d.width()/m.width,o=d.height()/m.height;f=Math.max(e,o),this.setScale(f),this.centerImage()}function o(t){this.crop()}function i(t){t.preventDefault();var e=p.offset(),o=d.offset();u={left:t.originalEvent&&t.originalEvent.touches?t.originalEvent.touches[0].pageX-(e.left-o.left):t.clientX-(e.left-o.left),top:t.originalEvent&&t.originalEvent.touches?t.originalEvent.touches[0].pageY-(e.top-o.top):t.clientY-(e.top-o.top)},$(document).on("mousemove touchmove",this.handleMouseMove),$(document).on("mouseup touchend",this.handleMouseUp)}function n(t){var e={left:t.originalEvent&&t.originalEvent.touches?t.originalEvent.touches[0].pageX:t.clientX,top:t.originalEvent&&t.originalEvent.touches?t.originalEvent.touches[0].pageY:t.clientY};p.css({left:e.left-u.left+"px",top:e.top-u.top+"px"})}function h(t){$(document).off("mousemove touchmove",this.handleMouseMove),$(document).off("mouseup touchend",this.handleMouseUp)}function s(t){var e=parseInt($(t.currentTarget).data("scale-by"))||.1;this.setScale(v-v*e)}function l(t){this.setScale(1),p.css({left:0,top:0})}function a(t){this.setScale(f),this.centerImage()}function c(t){var e=parseInt($(t.currentTarget).data("scale-by"))||.1;this.setScale(v+v*e)}this.CROPCOMPLETE="CROP_COMPLETE";var r,g,d,u,p,f,m,v,w;this.centerImage=function(){p.css({left:(d.width()-p.width())/2+"px",top:(d.height()-p.height())/2+"px"})},this.constructor=function(o,i){o?(g=!!i,w=o.length?o:$(o),e.call(this),t.call(this)):console.error("CropTool.constructor() => invalid DOM element given.")},this.crop=function(){if(!p.length)return void console.error("CropTool.crop() => trying to crop image when no image exists.");var t=document.createElement("canvas");if(t.height=d.height(),t.style.left="-1000%",t.style.position="absolute",t.style.top="-1000%",t.width=d.width(),$(document.body).append(t),t){var e=t.getContext("2d"),o={height:p.height(),left:p.position().left,top:p.position().top,width:p.width()},i={height:0,image:p.get(0),sheight:Math.round((o.height-o.top)/v),swidth:Math.round((o.width-o.left)/v),sx:Math.round(o.left<0?Math.abs(o.left/v):0),sy:Math.round(o.top<0?Math.abs(o.top/v):0),width:0,x:Math.round(o.left>0?o.left:0),y:Math.round(o.top>0?o.top:0)};i.height=Math.round(i.sheight*v),i.width=Math.round(i.swidth*v),g&&(console.log("CropTool.crop() => "),console.log("image == "+i.image),console.log("sx == "+i.sx),console.log("sy == "+i.sy),console.log("swidth == "+i.swidth),console.log("sheight == "+i.sheight),console.log("x == "+i.x),console.log("y == "+i.y),console.log("width == "+i.width),console.log("height == "+i.height)),e.drawImage(i.image,i.sx,i.sy,i.swidth,i.sheight,i.x,i.y,i.width,i.height),r=t.toDataURL("image/png",1),w.trigger(this.CROPCOMPLETE),$(t).remove()}},this.getDataUrl=function(){return r},this.getImageDetails=function(){var t=p.position();return{left:t.left,top:t.top}},this.getInitialScale=function(){return f},this.getScale=function(){return v},this.setScale=function(t){v=t,p.length?(p.css({height:m.height*v+"px",width:m.width*v+"px"}),g&&(console.log("CropTool.setScale() => "),console.log("_scale == "+v))):console.error("CropTool.setScale() => trying to set scale when no image is defined.")}});
